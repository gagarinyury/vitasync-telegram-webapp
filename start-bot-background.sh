#!/bin/bash

echo "๐ค ะะฐะฟััะบ ัะพะปัะบะพ Telegram ะฑะพัะฐ ะฒ ัะพะฝะต"
echo "====================================="

cd /root/vitasync-telegram-webapp

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฒัะต ะฟัะตะดัะดััะธะต ะฟัะพัะตััั
echo "๐ ะััะฐะฝะพะฒะบะฐ ะฟัะตะดัะดััะธั ะฟัะพัะตััะพะฒ..."
pkill -f "node" || true

# ะะฐะณััะถะฐะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
set -a
source .env
set +a

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะดะปั ะปะพะณะพะฒ
mkdir -p logs

# ะกะพะทะดะฐะตะผ ะผะธะฝะธะผะฐะปัะฝัะน ัะฐะนะป ัะพะปัะบะพ ะดะปั ะฑะพัะฐ
cat > bot-only.js << 'EOF'
const { Telegraf } = require('telegraf');

const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN);

// Start command
bot.command('start', async (ctx) => {
  const user = ctx.from;
  const webAppUrl = `${process.env.TELEGRAM_WEBAPP_URL}?tg_user_id=${user.id}`;
  
  await ctx.reply('ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฒ VitaSync! ๐\n\nะฏ ะฟะพะผะพะณั ะฒะฐะผ ะฐะฝะฐะปะธะทะธัะพะฒะฐัั ัะพะฒะผะตััะธะผะพััั ะฒะธัะฐะผะธะฝะพะฒ ะธ ะะะะพะฒ, ะฐ ัะฐะบะถะต ัะพะทะดะฐะฒะฐัั ะฟะตััะพะฝะฐะปัะฝัะน ะณัะฐัะธะบ ะฟัะธะตะผะฐ.\n\n๐ค P.S. ะฏ ะฒัะตะณะพ ะปะธัั ะฟัะพัะพัะธะฟ, ะฟะพััะพะผั ะฝะต ััะดะธัะต ะผะตะฝั ัััะพะณะพ! ะะฝะพะณะดะฐ ะผะพะณั ะฝะตะผะฝะพะณะพ ัะพัะผะพะทะธัั, ะฝะพ ััะฐัะฐััั ะธะทะพ ะฒัะตั ัะธะป ๐', {
    reply_markup: {
      inline_keyboard: [
        [
          {
            text: '๐ ะัะบัััั ะฟัะธะปะพะถะตะฝะธะต',
            web_app: { url: webAppUrl }
          }
        ],
        [
          {
            text: '๐ ะ ะฑะพัะต',
            callback_data: 'about'
          },
          {
            text: '๐ฌ ะะพะดะดะตัะถะบะฐ',
            callback_data: 'support'
          }
        ]
      ]
    }
  });
});

// About callback
bot.action('about', async (ctx) => {
  await ctx.answerCbQuery();
  await ctx.reply(`
๐ *ะ VitaSync*

VitaSync - ััะพ ะธะฝัะตะปะปะตะบััะฐะปัะฝัะน ะฟะพะผะพัะฝะธะบ ะดะปั ะฐะฝะฐะปะธะทะฐ ัะพะฒะผะตััะธะผะพััะธ ะฒะธัะฐะผะธะฝะพะฒ ะธ ะะะะพะฒ.

*ะะพะทะผะพะถะฝะพััะธ:*
โข ะะฝะฐะปะธะท ัะพะฒะผะตััะธะผะพััะธ ะดะพะฑะฐะฒะพะบ ั ะฟะพะผะพััั AI
โข ะกะพะทะดะฐะฝะธะต ะฟะตััะพะฝะฐะปัะฝะพะณะพ ะณัะฐัะธะบะฐ ะฟัะธะตะผะฐ
โข ะะฐััะฝะพ ะพะฑะพัะฝะพะฒะฐะฝะฝัะต ัะตะบะพะผะตะฝะดะฐัะธะธ
โข ะะฒะฐ ัะตะถะธะผะฐ AI: ััะฐะฝะดะฐััะฝัะน ะธ ะฟัะตะผะธัะผ

*ะะฐะบ ะฟะพะปัะทะพะฒะฐัััั:*
1. ะะฐะถะผะธัะต "ะัะบัััั ะฟัะธะปะพะถะตะฝะธะต"
2. ะะพะฑะฐะฒััะต ะฒะฐัะธ ะดะพะฑะฐะฒะบะธ
3. ะะพะปััะธัะต ะฐะฝะฐะปะธะท ัะพะฒะผะตััะธะผะพััะธ
4. ะกะพะทะดะฐะนัะต ะพะฟัะธะผะฐะปัะฝัะน ะณัะฐัะธะบ ะฟัะธะตะผะฐ

โ๏ธ *ะะฐะถะฝะพ:* ะะฐัะธ ัะตะบะพะผะตะฝะดะฐัะธะธ ะฝะต ะทะฐะผะตะฝััั ะบะพะฝััะปััะฐัะธั ะฒัะฐัะฐ!

๐ค *P.S.* ะฏ ะฟะพะบะฐ ััะพ ะฟัะพัะพัะธะฟ MVP, ัะฐะบ ััะพ ะตัะปะธ ััะพ-ัะพ ะฟะพะนะดะตั ะฝะต ัะฐะบ - ะฝะต ะพะฑะตัััะดััะต! ะะฐะฑะพัะฐั ะฒ ัะตะถะธะผะต ะฑะตัะฐ-ัะตััะธัะพะฒะฐะฝะธั ๐
`, 
    { parse_mode: 'Markdown' }
  );
});

// Support callback
bot.action('support', async (ctx) => {
  await ctx.answerCbQuery();
  await ctx.reply('ะะพ ะฒัะตะผ ะฒะพะฟัะพัะฐะผ ะพะฑัะฐัะฐะนัะตัั: @your_support_username');
});

// Handle errors
bot.catch((err, ctx) => {
  console.error('Error:', err);
});

// Launch bot
bot.launch();

console.log('Bot started at', new Date().toISOString());

// Graceful shutdown
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
EOF

# ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ ะฒ ัะพะฝะต
echo "๐ ะะฐะฟััะบ ะฑะพัะฐ..."
cd backend
nohup node ../bot-only.js > ../logs/bot.log 2>&1 &
BOT_PID=$!

echo ""
echo "โ ะะพั ะทะฐะฟััะตะฝ ั PID: $BOT_PID"
echo "๐ ะะพะณะธ: /root/vitasync-telegram-webapp/logs/bot.log"
echo ""
echo "๐ ะัะพัะผะพัั ะปะพะณะพะฒ:"
echo "   tail -f /root/vitasync-telegram-webapp/logs/bot.log"
echo ""
echo "๐ ะััะฐะฝะพะฒะบะฐ ะฑะพัะฐ:"
echo "   kill $BOT_PID"
echo ""
echo "๐ค ะะพั ัะฐะฑะพัะฐะตั ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต!"